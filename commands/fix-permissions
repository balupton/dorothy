#!/usr/bin/env bash
source "$DOROTHY/sources/essentials.sh"
source "$DOROTHY/sources/strict.bash"

if test -z "${1-}" -o -z "${user-}" -o -z "${group-}"; then
	stderr echo 'USAGE: env user=<user> group=<group> fix-permissions <...dir>'
	exit 1
fi

function do_user_then_root {
	#   -H, --set-home                set HOME variable to target user's home dir
	#   -u, --user=user               run command (or edit file) as specified user name or ID
	echo "sudo -H -u $user $*"
	if ! sudo -H -u "$user" "$@"; then
		echo "^ failed, trying an alternative..."
		echo "sudo $*"
		if ! sudo "$@"; then
			echo "^ alternative failed too, giving up."
			return 1
		fi
	fi
	echo "^ success"
}

for dir in "$@"; do
	echo
	ls -la "$dir"
	echo
	sudo chown -Rv "$user:$group" "$dir"
	do_user_then_root chmod -Rv g+rwx "$dir"
	do_user_then_root chmod -Rv u+rwx "$dir"
	echo
	ls -la "$dir"
	echo
done
