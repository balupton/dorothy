#!/usr/bin/env bash
source "$DOROTHY/sources/strict.bash"

# @todo have this publish the cloudflare worker, as right now it is a @balupton secret unfortunately

# @todo provide a --conigure flag

# dependencies
env QUIET=yes setup-util-httpie

# help
if is-help "$@"; then
	cat <<-EOF >/dev/stderr
		ABOUT:
		??????
	EOF
	return 22 # Invalid argument
fi

# =====================================
# Configuration

source "$DOROTHY/sources/config.bash"

# ddns.bash provides:
DDNS_WORKER=''
DDNS_WORKER_AUTH=''
DDNS_WORKER_TARGET=''
load_dorothy_config 'ddns.bash'

# options
option_worker="$(
	ask --required \
		--question="Enter the URL of the Cloudflare Worker that will apply your IP address to the the target URL." \
		--default="$DDNS_WORKER"
)"
option_worker_auth="$(
	ask --required \
		--question="Enter the Authorization header content for the Cloudflare Worker." \
		--default="$DDNS_WORKER_AUTH"
)"
option_worker_target="$(
	ask --required \
		--question="Enter the URL that the Cloudflare Worker will update to point to your IP address." \
		--default="$DDNS_WORKER_TARGET"
)"

# =====================================
# Action

# port="${1:?USAGE: ddns PORT}"
# ngrok http "$port"
# tunnel="$(fetch localhost:4040/api/tunnels | jq -r .tunnels[0].public_url)"
# tunnel="$(get-url-hostname "$tunnel")"

http --verbose --check-status "$option_worker" Authorization:"$option_worker_auth" content="$option_worker_target"
